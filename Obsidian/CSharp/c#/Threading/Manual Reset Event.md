---
tags:
  - Threading
  - Thread_Signaling
  - Synchronization
  - TPL
---

# Manual Reset Event vs Auto Reset Event

![[51.png]]

# Part 1
---

![[43.png]]

![[44.png]]

![[45.png]]

## Example
---

```CSharp
using System.Threading;

class Shared
{
	public static int[] Data { get; set; } // Stores data values generated by producer thread
	public static int DataCount { get; set; } // Total number of values
	public static ManualResetEvent Event { get; set; }
	
	static Shared()
	{
		Data = new int[15];
		DataCount = 0;
		Event = new ManualResetEvent(false); // unsignaled (false)	
	}
}

// Represents producer thread
class Producer
{
	public void Produce()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");
		
		// Generate some data and store it in the Data array
		
		for (int i = 0; i < Shared.Data.Length; i++)
		{
			Shared.Data[i] = i + 1;
			Thread.Sleep(300); // Simulate artificial latency (delay)
		}
		
		// Set the signal (signal that the producer has finished generating data)
		Shared.Event.Set();
		
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}


// Represents consumer thread
class Consumer
{
	public void Consume()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");
		Console.WriteLine("Consumer is waiting for producer thread to finish generating data");
		
		Shared.Event.WaitOne(); // consumer thread waits until the status of event becomes singaled
		
		Console.WriteLine("Consumer has received a signal from the Producer");
		
		// Read data
		Console.WriteLine("\n Data is");
		for (int i = 0; i < Shared.Data.Length; i++)
		{
			Console.WriteLine(Shared.Data[i]);
		}
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}

class Program2
{
	static void Main()
	{
		// Create objects of Producer and Consumer class
		Producer producer = new Producer();
		Consumer consumer = new Consumer();
		
		// Create delegate objects of ThreadStart
		ThreadStart threadStart1 = new ThreadStart(producer.Produce);
		ThreadStart threadStart2 = new ThreadStart(consumer.Consume);
		
		// Create thread objects
		Thread producerThread = new Thread(threadStart1) { Name = "Producer Thread" };
		Thread consumerThread = new Thread(threadStart2) { Name = "Consumer Thread" };
		
		// Start Threads
		producerThread.Start();
		consumerThread.Start();
		
		// Join both threads to the main threads
		producerThread.Join();
		consumerThread.Join();

		Console.WriteLine("End of main method");
	}
}
```

# Part 2
---

![[46.png]]

![[47.png]]

![[48.png]]

## Example
---

> [!info] The one provided in the course

> [!failure] Lacks proper synchronization
> **Premature Signal Reset**: In your original code, the `ManualResetEvent` (`Shared.Event`) is reset immediately after being signaled (`Set()`) inside the producer loop. This can cause the consumer thread to miss the signal, as it may reset the event before the consumer has had a chance to respond to the signal.
> 
> **Incomplete Consumer Waiting**: The consumer waits for the signal (`WaitOne()`) inside its loop, but the producer signals multiple times within its own loop without waiting for the consumer to acknowledge each signal. This can lead to the consumer potentially missing signals or not being properly synchronized with the producer.
> 
> [stackoverflow](https://stackoverflow.com/questions/15067369/manualreseteventslim-calling-set-followed-immediately-by-reset-doesnt-re)

```CSharp
using System.Threading;

class Shared
{
	public static int[] Data { get; set; } // Stores data values generated by producer thread
	
	public static int BatchCount { get; set; } // Total number of values
	public static int BatchSize { get; set; }
	public static ManualResetEvent Event { get; set; }
	
	static Shared()
	{
		Data = new int[15];
		BatchCount = 5;
		BatchSize = 3;
		Event = new ManualResetEvent(false); // unsignaled (false)
	}
}

// Represents producer thread
class Producer
{
	public void Produce()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");

		for (int i = 0; i < Shared.BatchCount; i++)
		{
			// Generate some data and store it in the Data array
			for (int j = 0; j < Shared.BatchSize; j++)
			{
				Shared.Data[i * Shared.BatchSize + j] = (i * Shared.BatchSize) + j + 1;
				Thread.Sleep(300); // Simulate artificial latency (delay)
			}
			
			// Set the signal (signal that the producer has finished generating data)
			Shared.Event.Set();
			
			// Reset the signal (makes the consumer thread wait for signal before reading next batch)
			Shared.Event.Reset();
		}
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}

// Represents consumer thread
class Consumer
{
	public void Consume()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");
		Console.WriteLine("Consumer is waiting for producer thread to finish generating data");
		
		for (int i = 0; i < Shared.BatchCount; i++)
		{
			Shared.Event.WaitOne(); // consumer thread waits until the status of event becomes singaled
			Console.WriteLine("Consumer has received a signal from the Producer");

			// Read data
			Console.WriteLine("\n Data is");
			for (int j = 0; j < Shared.BatchSize; j++)
			{
				Console.WriteLine(Shared.Data[i * Shared.BatchSize + j]);
			}
		}
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}

class Program2
{
	static void Main()
	{
		// Create objects of Producer and Consumer class
		Producer producer = new Producer();
		Consumer consumer = new Consumer();

		// Create delegate objects of ThreadStart
		ThreadStart threadStart1 = new ThreadStart(producer.Produce);
		ThreadStart threadStart2 = new ThreadStart(consumer.Consume);
		
		// Create thread objects
		Thread producerThread = new Thread(threadStart1) { Name = "Producer Thread" };
		Thread consumerThread = new Thread(threadStart2) { Name = "Consumer Thread" };
		
		// Start Threads
		producerThread.Start();
		consumerThread.Start();
		
		// Join both threads to the main threads
		producerThread.Join();
		consumerThread.Join();
		
		Console.WriteLine("End of main method");
	}
}
```


> [!info] Chatgpt enhancement

> [!success] Doesn't lack proper synchronization

```CSharp
using System.Threading;

class Shared
{
	public static int[] Data { get; set; } // Stores data values generated by producer thread
	public static int BatchCount { get; set; } // Total number of batches
	public static int BatchSize { get; set; }
	public static ManualResetEvent ProducerEvent { get; set; }
	public static ManualResetEvent ConsumerEvent { get; set; }

	static Shared()
	{
		Data = new int[15];
		BatchCount = 5;
		BatchSize = 3;
		ProducerEvent = new ManualResetEvent(true); // Producer starts first
		ConsumerEvent = new ManualResetEvent(false); // Consumer waits initially
	}
}

// Represents producer thread
class Producer
{
	public void Produce()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");

		for (int i = 0; i < Shared.BatchCount; i++)
		{
			Shared.ProducerEvent.WaitOne(); // Wait for the signal to produce

			// Generate some data and store it in the Data array
			for (int j = 0; j < Shared.BatchSize; j++)
			{
				Shared.Data[i * Shared.BatchSize + j] = (i * Shared.BatchSize) + j + 1;
				Thread.Sleep(300); // Simulate artificial latency (delay)
			}
			Console.WriteLine($"{Thread.CurrentThread.Name} produced batch {i + 1}");

			// Signal the consumer to consume
			Shared.ProducerEvent.Reset();
			Shared.ConsumerEvent.Set();
		}
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}

// Represents consumer thread
class Consumer
{
	public void Consume()
	{
		Console.WriteLine($"{Thread.CurrentThread.Name} started");

		for (int i = 0; i < Shared.BatchCount; i++)
		{
			Shared.ConsumerEvent.WaitOne(); // Wait for the signal to consume
			Console.WriteLine("Consumer has received a signal from the Producer");

			// Read data
			Console.WriteLine("\n Data is");
			for (int j = 0; j < Shared.BatchSize; j++)
			{
				Console.WriteLine(Shared.Data[i * Shared.BatchSize + j]);
			}
			Console.WriteLine($"{Thread.CurrentThread.Name} consumed batch {i + 1}");

			// Signal the producer to produce next batch
			Shared.ConsumerEvent.Reset();
			Shared.ProducerEvent.Set();
		}
		Console.WriteLine($"{Thread.CurrentThread.Name} Completed");
	}
}

class Program2
{
	static void Main()
	{
		// Create objects of Producer and Consumer class
		Producer producer = new Producer();
		Consumer consumer = new Consumer();

		// Create delegate objects of ThreadStart
		ThreadStart threadStart1 = new ThreadStart(producer.Produce);
		ThreadStart threadStart2 = new ThreadStart(consumer.Consume);

		// Create thread objects
		Thread producerThread = new Thread(threadStart1) { Name = "Producer Thread" };
		Thread consumerThread = new Thread(threadStart2) { Name = "Consumer Thread" };

		// Start Threads
		producerThread.Start();
		consumerThread.Start();

		// Join both threads to the main threads
		producerThread.Join();
		consumerThread.Join();

		Console.WriteLine("End of main method");
	}
}


```

