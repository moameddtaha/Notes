---
tags:
  - Framework
  - sub-directories
---

# The Metasploit framework
---
- The Metasploit Framework (MSF) is an open-source, robust penetration testing and exploitation framework that is used by penetration testers and security researchers worldwide.
- It provides penetration testers with a robust infrastructure required to automate every stage of the penetration testing life cycle.
- It is also used to develop and test exploits and has one of the world's largest database of public, tested exploits.
- The Metasploit Framework is designed to be modular, allowing for new functionality to be implemented with ease.

## History
---
![[Untitled.png]]
## Essential Terminology
---

| Terminology | Description |
| ---------- | --------- |
| Interface        | Methods of interacting with the Metasploit Framework.    |
| Module      | Pieces of code that perform a particular task, an example of a module is an exploit.     |
| Vulnerability | Weakness or flaw in a computer system or network that can be exploited. |
| Exploit | Piece of code/module that is used to take advantage a vulnerability within a system, service or application. |
| Payload | Piece of code delivered to the target system by an exploit with the objective of executing arbitrary commands or providing remote access to an attacker. |
| Listener | A utility that listens for an incoming connection from a target. |

## Interfaces

### Metasploit Framework CLI
---
- The Metasploit Framework Command Line Interface `(MSFcli)` is a command line utility that is used to facilitate the creation of automation scripts that utilize Metasploit modules.
- It can be used to redirect output from other tools in to `msfcli` and vice versa.

>[!Note]
>`MSFcli` was discontinued in 2015, however, the same functionality can be leveraged through the `MSFconsole`.

### Metasploit Community Edition
---
Metasploit Community Edition is a web based GUI front-end for the Metasploit Framework that simplifies network discovery and vulnerability identification.
![[Untitled1.png]]

### Armitage
---
Armitage is a free Java based GUI front-end for the Metasploit Framework that simplifies network discovery, exploitation and post exploitation.

> You can think of it as visual or GUI for the Metasploit Framework, or MSF-console. Any thing you can do with the MSF-console, you can do it with Armitage.

![[Untitled2.png]]

## MSF Architecture
---
A module in the context of MSF, is a piece of code that can be utilized by the MSF. The MSF libraries facilitate the execution of modules without having to write the code necessary in order to execute them.

![[Untitled.3png.png]]

## MSF Modules
---

| Modules | Description |
| ---------- | --------- |
| Exploit | A module that is used to take advantage of vulnerability and is typically paired with a payload.|
| Payload | Code that is delivered by MSF and remotely executed on the target after successful exploitation. An example of a payload is a reverse shell that initiates a connection from the target system back to the attacker.|
| Encoder | Used to encode payloads in order to avoid AV detection. For example, ==**_shikata_ga_nai_**== is used to encode Windows payloads.
| NOPS | Used to ensure that payloads sizes are consistent and ensure the stability of a payload when executed.|
| Auxiliary | A module that is used to perform additional functionality like port scanning and enumeration.|

## MSF Payloads Types
---
When working with exploits, MSF provides you with two types of payloads that can be paired with an exploit:
1. ==**Non-Staged Payload**== - Payload that is sent to the target system as is along with the exploit.
2. ==**Staged Payload**== - A staged payload is sent to the target in two parts, whereby:
	 - The first part (stager) contains a payload that is used to establish a reverse connection back to the attacker, download the second part of the payload (stage) and execute it.
### Stager & Stages
---

|  | |
| ------- | ------- |
| Stagers | Stagers are typically used to establish a stable communication channel between the attacker and target, after which a stage payload is downloaded and executed on the target system.|
| Stage | Payload components that are downloaded by the stager. |

## Meterpreter Payload
---
- The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional payload that is executed in memory on the target system making it difficult to detect.
- It communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging and much more.
- Meterpreter also allows us to load custom script and plugins dynamically.
- MSF provides us with various types of meterpreter payloads that can be used based on the target environment and the OS architecture.

## MSF File System Structure
---
The MSF file system is organized in a simple and easy to understand format and is organized into various directories.

![[Untitled4.png]]


## MSF Modules Locations
---
MSF stores modules under the following directory on Linux systems:
```terminal
/usr/share/metasploit-framework/modules
```

User specified modules are stored under the following directory on Linux systems:
```terminal
~/.ms4/modules
```

## [[Penetration Testing Execution Standard]]
---

|Penetration Testing Phase|Metasploit Framework Implementation|
|---|---|
|Information Gathering & Enumeration|Auxiliary Modules|
|Vulnerability Scanning|Auxiliary Modules|
|Exploitation|Exploit Modules & Payloads|
|Post Exploitation|Meterpreter|
|Privilege Escalation|Post Exploitation Modules Meterpreter|
|Maintaining Persistent Access|Post Exploitation Modules Persistence|

## Metasploit Framework Database
---
- The Metasploit Framework Database (`msfdb`) is an integral part of the Metasploit Framework and is used to keep track of all your assessments, host data scans etc.

- The Metasploit Framework uses PostgreSQL as the primary database server, as a result, we will also need to ensure that the PostgreSQL database service is running and configured correctly.

- The Metasploit Framework Database also facilitates the importation and storage of scan results from various third party tools like Nmap and Nessus.

## Installation Steps
---

1. Update our repositories and upgrade our Metasploit Framework to the latest version.
	
    ```bash
    sudo apt-get update && sudo apt-get install metasploit-framework -y
    ```

2. Start and enable the PostgreSQL database service.
	
    ```bash
    sudo systemctl enable postgresql
    ```
	> Enable PostgreSQL service to start on system startup.


3. Interact with `msfdb`
	
    ```bash
    sudo msfdb
    ```
	
    - Initialize the Metasploit Framework Database (`msfdb`)
        
        ```bash
        sudo msfdb init
        ```

|Command|Description|
|---|---|
|analyze|Analyze database information about a specific address or address range|
|db_connect|Connect to an existing data services|
|db_disconnect|Disconnect from the current data service|
|db_export|Export a file containing the contents of the database|
|db_import|Import a scan result file (filetype will be auto-detected)|
|db_nmap|Executes nmap and records the output automatically|
|db_rebuild_cache|Rebuilds the database-stored module cache (deprecated)|
|db_remove|Remove the saved data service entry|
|db_save|Save the current data service connection as the default to reconnect on startup|
|db_status|show the current data service status|
|hosts|List all hosts in the database|
|loot|List all loot in the database|
|notes|List all notes in the database|
|services|List all services in the database|
|vulns|List all vulnerabilities in the database|
|workspace|Switch between database workspaces|

> [!faq]- Before running the Metasploit scripts, we need to ensure that the PostgreSQL service is running.
To check the status of the PostgreSQL service, we can run the following command:
`sudo systemctl status postgresql`
If the service is not running, we can start it by running the following command:
`sudo systemctl start postgresql`
To start `postgresql` and run `msfconsole` at the same time:
`sudo systemctl start postgresql ; msfconsole`

4. Launch ==**MSFconsole!**==
```bash
msfconsole
```

## MSF Workspaces
---
- Workspaces allow you to keep track of all your hosts, scans and activities and are extremely useful when conducting penetration tests as they allow you to sort and organize your data based on the target or organization.

- `MSFconsole` provides you with the ability to create, manage and switch between multiple workspaces depending on your requirements.

- We will be using workspaces to organize our assessments as we progress through the course.

|Command|Descriptions|
|---|---|
|workspace|List workspaces|
|workspace -v|List workspaces verbosely|
|workspace [name]|Switch workspace(S)|
|workspace -a [name]|Add workspace(S)|
|workspace -d [name]|Delete workspace(S)|
|workspace -D|Delete all workspace(S)|
|workspace -r ``<old>`` ``<new>``|Rename workspace|
|workspace -h | Show this help information |

## Metasploit Resource Script
---
- Metasploit resource scripts are a great feature of MSF that allow you to automate repetitive tasks and commands.

- They operate similarly to batch scripts, whereby, you can specify a set of MSF console commands that you want to execute sequentially.

- You can the load the script with MSF console and automate the execution of the commands you specified in the resource script.

- We can use resource scripts to automate various tasks like setting up multi handlers as well as loading and executing payloads.

- There is a collection of resource scripts that come pre-packaged with kali Linux, you can view them by listing out the content of the directory
    ```bash
    /uar/share/metasploit-framework/scripts/resource
    ```

### Example
---
To create a multi handler with resource script.

1. Open text editor
    
    ```bash
    vim handler.rc
    ```
    
2. Create a resource script from outside MSF console.
    
    > Write the commands that you typically run when setting up the handler.
    
    ```bash
	    use multi/handler
	    set PAYLOAD windows/metasploit/reverse_tcp
	    set LHOST 10.10.10.5
	    set LPORT 1234
	    run
    ```
    
3. Create a resource script from inside MSF console.
    
    > You can export all the commands that you write into a resource script.
    
    ```bash
	    makerc <~/path/to/save/resource/script>
    ```
    
	![[Untitled6.png]]

> [!tip] You need to specify the entire path to avoid saving it in root directory.

4. Load the resource script from outside the Metasploit console.
    
    ```bash
    msfconsole -r handler.rc
    ```
    
    >Load the resource script from inside the Metasploit console.
    
    ```bash
	    resource <path/to/resource/script>
    ```

	![[Untitled7.png]]

